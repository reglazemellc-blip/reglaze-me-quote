rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Tenant claims - each user can only access their own claim
    match /tenantClaims/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Config - shared app config
    match /config/{configId} {
      allow read, write: if isAuthenticated();
    }
    
    // Catalog - shared catalog
    match /catalog/{docId} {
      allow read, write: if isAuthenticated();
    }
    
    // Services - shared services
    match /services/{serviceId} {
      allow read, write: if isAuthenticated();
    }
    
    // Settings - shared settings
    match /settings/{settingId} {
      allow read, write: if isAuthenticated();
    }
    
    // All tenant-isolated collections - authenticated users can access
    // Tenant filtering is enforced in application code via where('tenantId', '==', tenantId)
    
    match /clients/{clientId} {
      allow read, write: if isAuthenticated() && 
      request.auth.uid == 
      request.resource.data.tenantId;
    
    }
    match /quotes/{quoteId} {
      allow read, write: if isAuthenticated() && 
      request.auth.uid == 
      request.resource.data.tenantId;
    }
    
    match /invoices/{invoiceId} {
       allow read, write: if isAuthenticated() && 
      request.auth.uid == 
      request.resource.data.tenantId;
    }
    
    match /contracts/{contractId} {
       allow read, write: if isAuthenticated() && 
      request.auth.uid == 
      request.resource.data.tenantId;
    }
    
    match /companies/{companyId} {
       allow read, write: if isAuthenticated() && 
      request.auth.uid == 
      request.resource.data.tenantId;
    }
    
    match /properties/{propertyId} {
       allow read, write: if isAuthenticated() && 
      request.auth.uid == 
      request.resource.data.tenantId;
    }
  }
}
